# Nginx configuration for dev.magallan.online
# Add this to your existing nginx configuration

# OPTION 1: Add to existing server block (less recommended)
# Add this inside your existing "server" block for magallan.online:

    # Portfolio/Job Card site for dev.magallan.online
    location / {
        # Check if it's the dev subdomain
        if ($host = dev.magallan.online) {
            proxy_pass http://localhost:8002;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            break;
        }
        
        # Otherwise serve the main website
        root /var/www/magallan.online;
        index index.html;
        try_files $uri $uri/ =404;
        
        # ... rest of your location block
    }

# ============================================================
# OPTION 2: Separate server block (RECOMMENDED)
# Add this as a new server block in your nginx config:

server {
    listen 443 ssl http2;
    server_name dev.magallan.online;

    # SSL Configuration (same certificates as main domain)
    ssl_certificate /etc/letsencrypt/live/magallan.online-0001/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/magallan.online-0001/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    # Proxy to portfolio FastAPI app
    location / {
        proxy_pass http://localhost:8002;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Optional: Add timeout settings
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # Optional: Add security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
}

# HTTP to HTTPS redirect for dev subdomain
server {
    listen 80;
    server_name dev.magallan.online;
    
    location / {
        return 301 https://$host$request_uri;
    }
    
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }
}

# ============================================================
# DEPLOYMENT INSTRUCTIONS:
# 
# 1. Edit your nginx config:
#    sudo nano /etc/nginx/sites-available/magallan.online
#
# 2. Add the server block above (OPTION 2 is recommended)
#
# 3. Test the configuration:
#    sudo nginx -t
#
# 4. If test passes, reload nginx:
#    sudo systemctl reload nginx
#
# 5. Make sure your Docker container is running:
#    cd /path/to/magallan.online-server
#    docker-compose up -d
#
# 6. Check if it's working:
#    curl http://localhost:8002/health
#    
# 7. Visit https://dev.magallan.online in your browser
